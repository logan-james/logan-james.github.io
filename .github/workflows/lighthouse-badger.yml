# Lighthouse-Badger-Easy | GitHub Action Workflow
#
# Description: Generates, adds & updates manually/automatically Lighthouse badges & reports from one/multiple input URL(s) to the current repository & main branch with minimal settings
# Author: Sitdisch
# Source: https://github.com/myactionway/lighthouse-badger-workflows
# License: MIT
# Copyright (c) 2021 Sitdisch

name: "Lighthouse Badger"

env:
  URLS: https://logan-james.github.io/
  TOKEN_NAME: LIGHTHOUSE_BADGER_TOKEN
  REPO_BRANCH: "${{ github.repository }} master"
  MOBILE_LIGHTHOUSE_PARAMS: "--only-categories=performance,accessibility,best-practices,seo --throttling.cpuSlowdownMultiplier=2"
  DESKTOP_LIGHTHOUSE_PARAMS: "--only-categories=performance,accessibility,best-practices,seo --preset=desktop --throttling.cpuSlowdownMultiplier=1"

on:
  page_build:
  workflow_dispatch:

jobs:
  lighthouse-badger-easy:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Preparatory Tasks
        run: |
          REPOSITORY="${{ env.REPO_BRANCH% *}}"
          BRANCH="${{ env.REPO_BRANCH#* }}"
          echo "REPOSITORY=$REPOSITORY" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Debug Variables
        run: |
          echo "Repository: $REPOSITORY"
          echo "Branch: $BRANCH"
          echo "Token Name: $TOKEN_NAME"
        env:
          TOKEN_NAME: ${{ secrets.LIGHTHOUSE_BADGER_TOKEN }}

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.REPOSITORY }}
          token: ${{ secrets.LIGHTHOUSE_BADGER_TOKEN }}
          ref: ${{ env.BRANCH }}

      - uses: actions/checkout@v4
        with:
          repository: "myactionway/lighthouse-badges"
          path: temp_lighthouse_badges_nested

      - uses: myactionway/lighthouse-badger-action@v2.2
        with:
          urls: ${{ env.URLS }}
          mobile_lighthouse_params: ${{ env.MOBILE_LIGHTHOUSE_PARAMS }}
          desktop_lighthouse_params: ${{ env.DESKTOP_LIGHTHOUSE_PARAMS }}

      - name: Test Git Authentication
        run: |
          git ls-remote https://$GH_TOKEN@github.com/$REPOSITORY.git
        env:
          GH_TOKEN: ${{ secrets.LIGHTHOUSE_BADGER_TOKEN }}
